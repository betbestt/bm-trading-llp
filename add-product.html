<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Product - B&M Trading LLP</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h2>Admin Panel</h2>

  <div id="login-section">
    <input type="password" id="admin-pass" placeholder="Enter admin password">
    <button onclick="login()">Login</button>
  </div>

  <div id="admin-panel" style="display:none;">
    <h3>Add Product</h3>
    <input type="text" id="name" placeholder="Product Name"><br>
    <input type="number" id="price" placeholder="Price"><br>
    <input type="file" id="image"><br>
    <button onclick="uploadProduct()">Upload</button>

    <h3>Existing Products</h3>
    <ul id="product-list"></ul>
  </div>

  <script>
  const ADMIN_PASSWORD = "bmadmin"; // change this to your secret

  const USERNAME = "betbestt";
  const REPO = "bm-trading-llp";
  const CLOUD_NAME = "dsn2vb9yf";
  const UPLOAD_PRESET = "unsigned"; // replace later with your unsigned preset
  const GITHUB_TOKEN = ""; // paste temporarily for testing

  async function login() {
    const pass = document.getElementById('admin-pass').value;
    if (pass === ADMIN_PASSWORD) {
      document.getElementById('login-section').style.display = 'none';
      document.getElementById('admin-panel').style.display = 'block';
      loadProducts();
    } else {
      alert("Wrong password");
    }
  }

  async function uploadProduct() {
    const name = document.getElementById('name').value;
    const price = document.getElementById('price').value;
    const file = document.getElementById('image').files[0];

    // Upload image to Cloudinary
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', UPLOAD_PRESET);

    const cloudinaryRes = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
      method: 'POST',
      body: formData
    }).then(r => r.json());

    const imageUrl = cloudinaryRes.secure_url;

    // Fetch existing products
    const res = await fetch(`https://raw.githubusercontent.com/${USERNAME}/${REPO}/main/products.json`);
    const products = await res.json();

    const newProduct = { id: Date.now(), name, price, image: imageUrl, sold: false };
    products.push(newProduct);

    // Push to GitHub
    const updatedJson = JSON.stringify(products, null, 2);
    const fileRes = await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/products.json`, {
      method: 'PUT',
      headers: {
        Authorization: `token ${GITHUB_TOKEN}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        message: "Add new product",
        content: btoa(updatedJson),
        sha: await getSha()
      })
    });

    alert("Product uploaded!");
    loadProducts();
  }

  async function getSha() {
    const res = await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/products.json`);
    const data = await res.json();
    return data.sha;
  }

  async function loadProducts() {
    const res = await fetch(`https://raw.githubusercontent.com/${USERNAME}/${REPO}/main/products.json`);
    const products = await res.json();
    const list = document.getElementById("product-list");
    list.innerHTML = "";

    products.forEach(p => {
      const li = document.createElement("li");
      li.innerHTML = `
        <img src="${p.image}" width="80"> ${p.name} - $${p.price}
        <button onclick="markSold(${p.id})">${p.sold ? 'Sold' : 'Mark Sold'}</button>
        <button onclick="deleteProduct(${p.id})">Delete</button>
      `;
      list.appendChild(li);
    });
  }

  async function markSold(id) {
    const res = await fetch(`https://raw.githubusercontent.com/${USERNAME}/${REPO}/main/products.json`);
    const products = await res.json();

    const product = products.find(p => p.id === id);
    product.sold = !product.sold;

    const updatedJson = JSON.stringify(products, null, 2);
    await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/products.json`, {
      method: 'PUT',
      headers: {
        Authorization: `token ${GITHUB_TOKEN}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        message: "Update sold status",
        content: btoa(updatedJson),
        sha: await getSha()
      })
    });
    alert("Updated!");
    loadProducts();
  }

  async function deleteProduct(id) {
    const res = await fetch(`https://raw.githubusercontent.com/${USERNAME}/${REPO}/main/products.json`);
    let products = await res.json();

    products = products.filter(p => p.id !== id);

    const updatedJson = JSON.stringify(products, null, 2);
    await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/products.json`, {
      method: 'PUT',
      headers: {
        Authorization: `token ${GITHUB_TOKEN}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        message: "Delete product",
        content: btoa(updatedJson),
        sha: await getSha()
      })
    });
    alert("Deleted!");
    loadProducts();
  }
  </script>
</body>
</html>
