<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Add Product | B&M Trading LLP</title>
  <link rel="stylesheet" href="style.css">
  <style>
    main{ max-width:980px; margin:40px auto; padding:20px; }
    .admin-grid{ display:grid; grid-template-columns: 1fr 380px; gap:20px; }
    .card{ background:var(--bg); padding:16px; border-radius:12px; box-shadow:var(--card-shadow); }
    .product-list{ max-height:540px; overflow:auto; }
    .product-row{ display:flex; gap:12px; align-items:center; margin-bottom:10px; }
    .product-row img{ width:78px; height:78px; object-fit:cover; border-radius:8px; }
    .btn{ padding:8px 12px; border-radius:8px; border:none; background:var(--accent); color:#fff; cursor:pointer; }
    .btn-danger{ background:#dc2626; }
    .small{ font-size:13px; color:var(--muted-text); }
    .login-modal{ position:fixed; inset:0; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:999; }
    .login-box{ width:380px; background:#fff; padding:20px; border-radius:12px; box-shadow:var(--card-shadow); }
  </style>
</head>
<body>
  <header class="navbar">
    <div class="navbar-inner">
      <div class="brand">B&M Trading LLP — Admin</div>
      <div class="nav-links">
        <a href="index.html">Home</a>
        <a href="cart.html">Cart</a>
        <a href="store-info.html">Store Info</a>
      </div>
    </div>
  </header>
  <div style="height:64px;"></div>

  <main>
    <div class="admin-grid">
      <!-- Left: Add product form -->
      <div class="card">
        <h2>Add Product</h2>
        <p class="small">Only the owner can add — login required.</p>

        <label>GitHub Username (owner)</label>
        <input id="githubUser" placeholder="GITHUB_USERNAME (or leave blank to enter later)" style="width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #e6e9ef;">

        <label>Repository Name</label>
        <input id="repoName" placeholder="REPO_NAME (e.g. bm-trading-llp)" style="width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #e6e9ef;">

        <label>Cloudinary Cloud</label>
        <input id="cloudName" placeholder="CLOUDINARY_CLOUD" style="width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #e6e9ef;">

        <label>Cloudinary Upload Preset (unsigned)</label>
        <input id="uploadPreset" placeholder="CLOUDINARY_UPLOAD_PRESET" style="width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #e6e9ef;">

        <hr style="margin:12px 0;">
        <label>Admin Phone (0720300388)</label>
        <input id="adminPhone" placeholder="phone" style="width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #e6e9ef;">
        <label>Admin Password (Brian)</label>
        <input id="adminPass" type="password" placeholder="password" style="width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #e6e9ef;">

        <button id="openLogin" class="btn" style="margin-top:8px;">Login</button>

        <div id="formArea" class="hidden" style="margin-top:14px;">
          <label>Product Name</label>
          <input id="pName" style="width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #e6e9ef;">
          <label>Price (KSh)</label>
          <input id="pPrice" type="number" style="width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #e6e9ef;">
          <label>Category</label>
          <select id="pCategory" style="width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #e6e9ef;">
            <option>iPhones</option><option>MacBooks</option><option>iPads</option><option>Apple Watches</option><option>Accessories</option><option>Others</option>
          </select>
          <label>Description</label>
          <textarea id="pDesc" style="width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #e6e9ef;"></textarea>

          <label>Image</label>
          <input id="pImage" type="file" accept="image/*" style="margin:8px 0;">
          <div id="preview"></div>

          <label>GitHub Token (paste here for quick demo)</label>
          <input id="ghToken" placeholder="Paste GitHub token here (will be stored in sessionStorage)" style="width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #e6e9ef;">

          <button id="uploadBtn" class="btn" style="width:100%;margin-top:8px;">Upload to GitHub</button>
        </div>
      </div>

      <!-- Right: product list with actions -->
      <div class="card">
        <h3>Products (live from products.json)</h3>
        <div style="margin:8px 0 12px 0;">
          <button id="refreshBtn" class="btn" style="margin-right:8px;">Refresh</button>
          <span class="small">Only logged-in admin can change products.</span>
        </div>
        <div id="productList" class="product-list"></div>
      </div>
    </div>
  </main>

  <div id="loginModal" class="login-modal hidden">
    <div class="login-box">
      <h3 style="margin:0 0 8px 0;">Admin Login</h3>
      <p class="small">Use phone: <strong>0720300388</strong> and password: <strong>Brian</strong></p>
      <button id="closeLogin" class="btn" style="margin-top:8px;">Close</button>
    </div>
  </div>

  <footer style="margin:40px 0;"></footer>

  <script>
    // ---------- Helpers ----------
    const toast = (msg) => {
      const t = document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t);
      setTimeout(()=>t.classList.add('show'),10); setTimeout(()=>{t.classList.remove('show'); setTimeout(()=>t.remove(),300)},2200);
    };

    // ---------- Elements ----------
    const openLogin = document.getElementById('openLogin');
    const loginModal = document.getElementById('loginModal');
    const closeLogin = document.getElementById('closeLogin');
    const formArea = document.getElementById('formArea');
    const adminPhone = document.getElementById('adminPhone');
    const adminPass = document.getElementById('adminPass');
    const refreshBtn = document.getElementById('refreshBtn');

    const githubUserIn = document.getElementById('githubUser');
    const repoNameIn = document.getElementById('repoName');
    const cloudNameIn = document.getElementById('cloudName');
    const uploadPresetIn = document.getElementById('uploadPreset');
    const ghTokenIn = document.getElementById('ghToken');

    const pName = document.getElementById('pName');
    const pPrice = document.getElementById('pPrice');
    const pCategory = document.getElementById('pCategory');
    const pDesc = document.getElementById('pDesc');
    const pImage = document.getElementById('pImage');
    const preview = document.getElementById('preview');

    const uploadBtn = document.getElementById('uploadBtn');
    const productList = document.getElementById('productList');

    // ---------- Config helpers ----------
    function getCfg(key){
      return sessionStorage.getItem(key) || '';
    }
    function setCfg(key,val){
      sessionStorage.setItem(key,val);
    }

    // Load stored config values into inputs
    githubUserIn.value = getCfg('GITHUB_USERNAME');
    repoNameIn.value = getCfg('REPO_NAME');
    cloudNameIn.value = getCfg('CLOUDINARY_CLOUD');
    uploadPresetIn.value = getCfg('CLOUDINARY_UPLOAD_PRESET');
    ghTokenIn.value = getCfg('GITHUB_TOKEN');

    // ---------- Admin login ----------
    openLogin.addEventListener('click', ()=>{
      const phone = adminPhone.value.trim();
      const pass = adminPass.value.trim();
      if(phone === '0720300388' && pass === 'Brian'){
        // save config inputs for convenience
        if(githubUserIn.value) setCfg('GITHUB_USERNAME', githubUserIn.value.trim());
        if(repoNameIn.value) setCfg('REPO_NAME', repoNameIn.value.trim());
        if(cloudNameIn.value) setCfg('CLOUDINARY_UPLOAD_PRESET', uploadPresetIn.value.trim());
        if(cloudNameIn.value) setCfg('CLOUDINARY_CLOUD', cloudNameIn.value.trim());
        if(ghTokenIn.value) { setCfg('GITHUB_TOKEN', ghTokenIn.value.trim()); sessionStorage.setItem('GITHUB_TOKEN', ghTokenIn.value.trim()); }
        loginModal.classList.add('hidden');
        formArea.classList.remove('hidden');
        toast('Admin logged in');
        loadProducts(); // display products
      } else {
        toast('Invalid admin credentials');
      }
    });
    closeLogin.addEventListener('click', ()=> loginModal.classList.add('hidden'));

    // ---------- Preview image ----------
    pImage.addEventListener('change', (e)=>{
      const f = e.target.files[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = ev => {
        preview.innerHTML = `<img src="${ev.target.result}" style="width:100%;max-height:220px;object-fit:cover;border-radius:8px;">`;
      };
      reader.readAsDataURL(f);
    });

    // ---------- GitHub utility functions ----------
    async function githubGetFile(path){
      const user = githubUserIn.value.trim() || getCfg('GITHUB_USERNAME');
      const repo = repoNameIn.value.trim() || getCfg('REPO_NAME');
      if(!user || !repo) throw new Error('Missing GitHub repo user/repo');
      const url = `https://api.github.com/repos/${user}/${repo}/contents/${path}`;
      const token = sessionStorage.getItem('GITHUB_TOKEN');
      const res = await fetch(url, {
        headers: token ? { Authorization: 'token '+token } : {}
      });
      if(!res.ok) throw new Error(`GitHub GET failed: ${res.status}`);
      return await res.json();
    }

    async function githubPutFile(path, contentBase64, sha, message='update products.json'){
      const user = githubUserIn.value.trim() || getCfg('GITHUB_USERNAME');
      const repo = repoNameIn.value.trim() || getCfg('REPO_NAME');
      if(!user || !repo) throw new Error('Missing GitHub repo user/repo');
      const url = `https://api.github.com/repos/${user}/${repo}/contents/${path}`;
      const token = sessionStorage.getItem('GITHUB_TOKEN');
      if(!token) throw new Error('Missing GitHub token (set it in the form)');
      const body = {
        message,
        content: contentBase64,
        sha
      };
      const res = await fetch(url, {
        method:'PUT',
        headers: { Authorization: 'token '+token, 'Content-Type':'application/json' },
        body: JSON.stringify(body)
      });
      if(!res.ok) {
        const txt = await res.text();
        throw new Error('GitHub PUT failed: '+res.status+' '+txt);
      }
      return await res.json();
    }

    // ---------- Cloudinary upload ----------
    async function uploadImageToCloudinary(file){
      const cloud = cloudNameIn.value.trim() || getCfg('CLOUDINARY_CLOUD');
      const preset = uploadPresetIn.value.trim() || getCfg('CLOUDINARY_UPLOAD_PRESET');
      if(!cloud || !preset) throw new Error('Cloudinary cloud name or upload preset missing');
      const url = `https://api.cloudinary.com/v1_1/${cloud}/upload`;
      const fd = new FormData();
      fd.append('file', file);
      fd.append('upload_preset', preset);
      const res = await fetch(url, { method:'POST', body:fd });
      if(!res.ok) throw new Error('Cloudinary upload failed');
      return await res.json();
    }

    // ---------- Load products.json from repo (via raw or GitHub API) ----------
    async function loadProducts(){
      productList.innerHTML = 'Loading...';
      try {
        // Attempt to load via raw file over site domain: /products.json
        const baseRaw = '/products.json';
        let products = [];
        try {
          const r = await fetch(baseRaw + '?t=' + Date.now(), {cache:'no-store'});
          if(r.ok) {
            products = await r.json();
          } else {
            // fallback to GitHub API (requires username/repo)
            const file = await githubGetFile('products.json');
            products = JSON.parse(atob(file.content));
          }
        } catch(e){
          // fallback to GitHub API
          const file = await githubGetFile('products.json');
          products = JSON.parse(atob(file.content));
        }

        if(!Array.isArray(products)) products = [];
        productList.innerHTML = '';
        products.forEach((p, idx)=>{
          const row = document.createElement('div'); row.className='product-row';
          row.innerHTML = `
            <img src="${p.imageURL || ''}" alt="">
            <div style="flex:1;">
              <div style="font-weight:700">${p.name}</div>
              <div class="small">${p.category} • KSh ${Number(p.price).toLocaleString()}</div>
              <div class="small">${p.description||''}</div>
              <div style="margin-top:8px;">
                <button class="btn" data-idx="${idx}" data-action="toggle-sold">${p.sold ? 'Mark Available' : 'Mark Sold'}</button>
                <button class="btn btn-danger" data-idx="${idx}" data-action="delete" style="margin-left:8px;">Delete</button>
              </div>
            </div>
          `;
          productList.appendChild(row);
        });
      } catch (err) {
        console.error(err);
        productList.innerHTML = `<div class="small">Failed to load products: ${err.message}</div>`;
      }
    }

    refreshBtn.addEventListener('click', loadProducts);

    // ---------- Upload new product flow ----------
    uploadBtn.addEventListener('click', async ()=>{
      try {
        const name = pName.value.trim();
        const price = Number(pPrice.value);
        const category = pCategory.value;
        const description = pDesc.value.trim();
        const file = pImage.files[0];
        const cloud = cloudNameIn.value.trim() || getCfg('CLOUDINARY_CLOUD');
        const preset = uploadPresetIn.value.trim() || getCfg('CLOUDINARY_UPLOAD_PRESET');

        // persist config
        if(githubUserIn.value) setCfg('GITHUB_USERNAME', githubUserIn.value.trim());
        if(repoNameIn.value) setCfg('REPO_NAME', repoNameIn.value.trim());
        if(cloud) setCfg('CLOUDINARY_CLOUD', cloud);
        if(preset) setCfg('CLOUDINARY_UPLOAD_PRESET', preset);
        if(ghTokenIn.value) { setCfg('GITHUB_TOKEN', ghTokenIn.value.trim()); sessionStorage.setItem('GITHUB_TOKEN', ghTokenIn.value.trim()); }

        if(!name || !price || !file) { toast('Please provide name, price and image'); return; }
        toast('Uploading image to Cloudinary...');
        const upl = await uploadImageToCloudinary(file);
        const imageURL = upl.secure_url;

        toast('Fetching products.json from GitHub...');
        const fileMeta = await githubGetFile('products.json');
        const current = JSON.parse(atob(fileMeta.content));
        const newProduct = {
          id: 'p_' + Date.now(),
          name, price, category, description, imageURL, createdAt: new Date().toISOString(), sold:false
        };
        current.unshift(newProduct);

        const contentBase64 = btoa(unescape(encodeURIComponent(JSON.stringify(current, null, 2))));
        toast('Updating products.json in repository...');
        await githubPutFile('products.json', contentBase64, fileMeta.sha, `Add product ${name}`);
        toast('Product uploaded successfully!');
        // reset form
        pName.value=''; pPrice.value=''; pDesc.value=''; pImage.value=''; preview.innerHTML='';
        // reload list
        setTimeout(loadProducts, 1200);
      } catch (err) {
        console.error(err);
        toast('Error: ' + (err.message||err));
      }
    });

    // ---------- Handle product list actions (sold/delete) ----------
    productList.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      const idx = Number(btn.dataset.idx);
      const action = btn.dataset.action;
      if(isNaN(idx) || !action) return;

      try {
        toast('Fetching current products...');
        const fileMeta = await githubGetFile('products.json');
        const current = JSON.parse(atob(fileMeta.content));
        if(action === 'delete'){
          if(!confirm('Delete this product?')) return;
          current.splice(idx,1);
        } else if(action === 'toggle-sold'){
          current[idx].sold = !current[idx].sold;
        }
        const contentBase64 = btoa(unescape(encodeURIComponent(JSON.stringify(current, null, 2))));
        toast('Updating repository...');
        await githubPutFile('products.json', contentBase64, fileMeta.sha, action === 'delete' ? `Delete product` : `Toggle sold`);
        toast('Updated successfully');
        setTimeout(loadProducts,1000);
      } catch(err){
        console.error(err);
        toast('Error: ' + (err.message||err));
      }
    });

    // try to load on page open
    (function init(){
      // If token saved in sessionStorage, show form
      if(sessionStorage.getItem('GITHUB_TOKEN')) {
        formArea.classList.remove('hidden');
      }
      loadProducts();
    })();
  </script>
</body>
</html>
