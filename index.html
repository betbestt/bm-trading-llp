<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>B&M Trading LLP â€” Shop</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="site-header">
    <div class="header-inner">
      <div class="brand">
        <div class="logo">B&amp;M Trading LLP</div>
        <div class="tag">Premium Apple Products â€” Nairobi</div>
      </div>

      <nav class="main-nav">
        <a href="index.html" class="nav-link">Home</a>
        <a href="add-product.html" class="nav-link">Add Product</a>
        <a href="cart.html" class="nav-link cart-link">Cart</a>
      </nav>
    </div>
  </header>

  <main>
    <!-- HERO -->
    <section class="hero">
      <div class="hero-inner">
        <div class="hero-content">
          <h1>The Latest Apple &amp; Tech Products</h1>
          <p class="lead">Shop premium iPhones, MacBooks and accessories â€” genuine products, local warranty.</p>
          <div class="hero-actions">
            <a href="#products" class="btn btn-primary">Shop Trending</a>
            <a href="contact.html" class="btn btn-ghost">Store Info</a>
          </div>
        </div>
        <div class="hero-image" aria-hidden="true">
          <!-- decorative image -->
        </div>
      </div>
    </section>

    <!-- PROMO BAR -->
    <section class="promo-bar">
      <div class="promo-inner">
        <span>Free delivery for orders above <strong>KSh 20,000</strong></span>
        <span class="promo-sep">|</span>
        <span>Secure payments â€¢ Genuine products</span>
      </div>
    </section>

    <!-- PRODUCTS -->
    <section id="products" class="products-section">
      <div class="section-inner">
        <h2>Featured Products</h2>
        <div id="product-grid" class="product-grid" aria-live="polite"></div>
        <p id="no-products" class="no-products" style="display:none;">No products yet â€” add some from the Add Product page.</p>
      </div>
    </section>

    <!-- ABOUT -->
    <section class="about-section">
      <div class="section-inner about-inner">
        <div>
          <h3>About B&amp;M Trading</h3>
          <p>We are a trusted electronics retailer based in Nairobi â€” specialising in authentic Apple devices and accessories. Visit us at Queensway House, Kaunda Street.</p>
        </div>
        <div>
          <h3>Contact</h3>
          <p><strong>Phone:</strong> 0720 300 388</p>
          <p><strong>Address:</strong> Queensway House, Kaunda St, Nairobi</p>
        </div>
      </div>
    </section>
  </main>

  <!-- WhatsApp -->
  <a class="whatsapp-fab" href="https://wa.me/254720300388" target="_blank" rel="noopener" title="Chat with us on WhatsApp">ðŸ’¬</a>

  <footer class="site-footer">
    <div class="footer-inner">
      <div>Â© <span id="year"></span> B&amp;M Trading LLP</div>
      <div>Built with care â€” Nairobi</div>
    </div>
  </footer>

  <!-- Firebase + logic -->
  <script type="module">
    // Firebase v11 imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // === Use corrected firebase config ===
    const firebaseConfig = {
      apiKey: "AIzaSyCjf6QOf7gdq1StOBdf5zWtWyde-Gis0Nc",
      authDomain: "bm-trading-llp.firebaseapp.com",
      projectId: "bm-trading-llp",
      storageBucket: "bm-trading-llp.appspot.com",
      messagingSenderId: "760421393441",
      appId: "1:760421393441:web:bda19fd259add66b892f60",
      measurementId: "G-FXSZ8BFMK2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // helpers
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
    function formatNumber(n){ return Number(n).toLocaleString(); }

    // load products from Firestore
    async function loadProducts(){
      const grid = document.getElementById("product-grid");
      const noProducts = document.getElementById("no-products");
      grid.innerHTML = "";

      try {
        // try ordering by createdAt if present, fallback to document order
        const q = query(collection(db, "products"), orderBy("createdAt", "desc"));
        const snap = await getDocs(q);

        if (snap.empty) {
          noProducts.style.display = "block";
          return;
        } else {
          noProducts.style.display = "none";
        }

        snap.forEach(doc => {
          const data = doc.data();
          const name = escapeHtml(data.name || "Unnamed");
          const price = data.price ?? 0;
          const image = data.imageURL || "https://via.placeholder.com/600x400?text=No+Image";
          const desc = escapeHtml(data.description || "");

          const card = document.createElement("article");
          card.className = "product-card";
          card.innerHTML = `
            <div class="card-media"><img src="${image}" alt="${name}"></div>
            <div class="card-body">
              <h3 class="card-title">${name}</h3>
              <p class="card-desc">${desc}</p>
              <div class="card-footer">
                <div class="price">KSh ${formatNumber(price)}</div>
                <button class="add-cart" 
                  data-id="${doc.id}"
                  data-name="${name}"
                  data-price="${price}"
                  data-image="${image}">
                  Add to Cart
                </button>
              </div>
            </div>
          `;
          grid.appendChild(card);
        });
      } catch (err) {
        console.error("Error loading products:", err);
        grid.innerHTML = `<div class="load-error">Failed to load products. Check Firebase config & console.</div>`;
      }
    }

    // cart logic (localStorage)
    function addToCart(product){
      const cart = JSON.parse(localStorage.getItem("cart")) || [];
      const existing = cart.find(i => i.id === product.id);
      if (existing) {
        existing.quantity = (existing.quantity || 1) + 1;
      } else {
        product.quantity = 1;
        cart.push(product);
      }
      localStorage.setItem("cart", JSON.stringify(cart));
      // small toast-like feedback
      const t = document.createElement("div");
      t.className = "toast";
      t.textContent = `${product.name} added to cart`;
      document.body.appendChild(t);
      setTimeout(()=> t.classList.add("show"), 10);
      setTimeout(()=> { t.classList.remove("show"); setTimeout(()=>t.remove(),300); }, 2000);
    }

    // delegate add-cart clicks
    document.addEventListener("click", (e) => {
      if (e.target.classList.contains("add-cart")) {
        const dataset = e.target.dataset;
        addToCart({
          id: dataset.id,
          name: dataset.name,
          price: Number(dataset.price),
          image: dataset.image
        });
      }
    });

    // set current year
    document.getElementById("year").textContent = new Date().getFullYear();

    // initialize
    loadProducts();
  </script>
</body>
</html>
